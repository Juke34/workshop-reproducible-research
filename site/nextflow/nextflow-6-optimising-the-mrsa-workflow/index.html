<!DOCTYPE html>
<html lang="en">
	<head>
		
		
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<meta name="author" content="Jacques Dainat et al.">
		<link rel="canonical" href="https://Juke34.github.io/workshop-reproducible-research/nextflow/nextflow-6-optimising-the-mrsa-workflow/">
		<link rel="shortcut icon" href="../../img/favicon.ico">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<title>The MRSA Workflow - Bioinformatics Workshop on Tools for Reproducible Research</title>
		<link href="../../bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
		<link href="../../css/font-awesome-5.12.2-all.min.css" rel="stylesheet">
		<link href="../../css/base.css" rel="stylesheet">
		<link rel="stylesheet" href="../../css/highlight-github.css">
		<script src="../../bootstrap/dist/js/bootstrap.min.js"></script>
		<script src="../../js/highlight.pack.js"></script>
		
		<script>
			var base_url = '../..';
			var home_url = '../../usage';
			var is_outer_page = false;
			
			var pageToc = [
				{title: "Remote files", url: "#_top", children: [
				]},
				{title: "Subworkflows", url: "#subworkflows", children: [
				]},
			];

		</script>
		<script src="../../js/base.js"></script> 
	</head>

	<body class="inner-page">
		

		<div class="container-fluid wm-page-content">
			<a name="_top" aria-hidden="true"></a>
			






<div class="row pt-2 pb-4">
	<div class="col-sm text-center text-sm-left">
		<a href="../nextflow-5-workflow-configuration/" class="btn btn-sm btn-outline-dark">
			<i class="fa fa-chevron-left" aria-hidden="true"></i>
			Previous
		</a>
		<a href="../nextflow-5-workflow-configuration/" class="btn btn-sm btn-link">
			Configuration
		</a>
	</div>
	

	
	<div class="col-sm text-center text-sm-right">
		<a href="../nextflow-7-extra-material/" class="btn btn-sm btn-link">
			Extra materiel
		</a>
		<a href="../nextflow-7-extra-material/" class="btn btn-sm btn-outline-dark">
			Next
			<i class="fa fa-chevron-right" aria-hidden="true"></i>
		</a>
	</div>
	
</div>

			

			<p>We just added several parameters and configurations to our MRSA workflow, but
we didn't do anything about the reference genomes: those are still hard-coded.
How come? Well, the current MRSA workflow is, in fact, not very well-optimised
for Nextflow at all, being a refactor from the Snakemake tutorial of this
course.</p>
<p>All of the processes are basically unchanged, excluding some minor alterations.
For example, the <code>run_fastqc</code> rule in Snakemake used the <code>-o</code> flag to specify
that the results should be in the current directory, followed by moving the
output files to their respective output directory. The first part is not needed
in Nextflow (as everything is run in its own subdirectory), and the second part
is done by the <code>publishDir</code> directive. These are just minor alterations,
though, but we can do much more if we fully utilise Nextflow's features!</p>
<h1 id="remote-files">Remote files<a class="headerlink" href="#remote-files" title="Permanent link">#</a></h1>
<p>One of these features is the ability to automatically download remote files,
without needing to explicitly do so! The <code>path</code> input type can handle either
file paths (like we've done so far) or a URI-supported protocol (such as
<code>http://</code>, <code>s3://</code>, <code>ftp://</code>, <em>etc.</em>). This would be highly useful for <em>e.g.</em>
the <code>GET_GENOME_FASTA</code> process - in fact, we don't even need that process at
all! All we need to do is to change the input to the <code>INDEX_GENOME</code> and
<code>ALIGN_TO_GENOME</code> processes.</p>
<ul>
<li>
<p>Create a new input channel using the <code>fromPath()</code> channel factory and the
  absolute path to the genome FASTA.</p>
</li>
<li>
<p>Make the <code>INDEX_GENOME</code> process use that input channel instead of the
  previously used output of the <code>GET_GENOME_FASTA</code> process.</p>
</li>
<li>
<p>Remove the <code>GET_GENOME_FASTA</code> process, as it is not needed anymore.</p>
</li>
</ul>
<p>Re-run the workflow to see if it worked. Check the code below for an example if
you're stuck:</p>
<details>
<summary> Click to show </summary>


<pre><code class="language-nextflow"># Channel creation

ch_genome_fasta = Channel.fromPath( &quot;ftp://ftp.ensemblgenomes.org/pub/bacteria/release-37/fasta/bacteria_18_collection/staphylococcus_aureus_subsp_aureus_nctc_8325/dna/Staphylococcus_aureus_subsp_aureus_nctc_8325.ASM1342v1.dna_rm.toplevel.fa.gz&quot; )

# Workflow definition
INDEX_GENOME (
    ch_genome_fasta
)
</code></pre>


</details>

<p>If we want to get detailed we can also change the hard-coded "NCT8325"
naming in <em>e.g.</em> the <code>INDEX_GENOME</code> process and put that in another parameter,
or grab the <code>baseName()</code> from the channel and make a <code>[prefix, file]</code> tuple
using the <code>map{}</code> operator like we did previously; check below if you're
curious of how this could be done.</p>
<details>
<summary> Click to show </summary>


<pre><code class="language-nextflow">// Channel definition
ch_genome_fasta = Channel
    .fromPath( &quot;ftp://ftp.ensemblgenomes.org/pub/bacteria/release-37/fasta/bacteria_18_collection/staphylococcus_aureus_subsp_aureus_nctc_8325/dna/Staphylococcus_aureus_subsp_aureus_nctc_8325.ASM1342v1.dna_rm.toplevel.fa.gz&quot; )
    .map{ file -&gt; tuple(file.getBaseName(), file) }

// INDEX_GENOME process definition
process INDEX_GENOME {

    publishDir &quot;results/intermediate/&quot;,
        mode: &quot;copy&quot;

    input:
    tuple val(fasta_name), path(fasta)

    output:
    path(&quot;*.b2t&quot;), emit: index

    script:
    &quot;&quot;&quot;
    # Bowtie2 cannot use .gz, so unzip to a temporary file first
    gunzip -c ${fasta} &gt; tempfile
    bowtie2-build tempfile ${fasta_name}
    &quot;&quot;&quot;
}
</code></pre>


</details>

<h1 id="subworkflows">Subworkflows<a class="headerlink" href="#subworkflows" title="Permanent link">#</a></h1>
<p>The DSL2 allows highly modular workflow design, where a workflow may contain
multiple <em>subworkflows</em>. A subworkflow is just like a normal workflow, but it
can be called inside other workflows, similar to a process. There is thus no
special difference between a subworkflow and a workflow; the only difference is
how you use them in practice. Let's take a look at a toy example:</p>
<pre><code class="language-nextflow">workflow {
    ch_input = Channel.fromPath( params.input )
    SUBWORKFLOW( ch_input )
}

workflow SUBWORKFLOW {

    take:
    input_file

    main:
    ALIGN_READS( input_file )

    emit:
    bam = ALIGN_READS.out.bam
}
</code></pre>
<p>Here we have an unnamed, main workflow like before, plus a named subworkflow.
A workflow can have inputs specified by the <code>take</code> directive, which is
the equivalent of process <code>input</code> for workflows. The <code>main</code> part is
the workflow body, which contains how to run which processes in which order.
The last part, <code>emit</code>, also works the same as for processes, in that we name
the different outputs of the workflow so that we may use them in other
workflows or processes. Nextflow will run the unnamed workflow by default,
unless the <code>-entry</code> flag is specified, like so:</p>
<pre><code class="language-bash">nextflow run main.nf -entry SUBWORKFLOW
</code></pre>
<p>This will run the workflow named <code>SUBWORKFLOW</code>, but nothing else. You can also
store subworkflows in separate files, so that everything doesn't have to be
crammed into a single <code>main.nf</code> file. A subworkflow named <code>SUBWORKFLOW</code>
contained in the file <code>subworkflow.nf</code> can be loaded into a <code>main.nf</code> file like
so:</p>
<pre><code class="language-nextflow">include { SUBWORKFLOW } from &quot;./subworkflow.nf&quot;
</code></pre>
<p>If you have a complex workflow with several subworkflows you might thus store
them in a separate directory, <em>e.g.</em> <code>subworkflows</code>. This allows you to have
fine-grained control over the general architecture of your Nextflow workflows,
organising them in a manner that is easy to code and maintain. A <code>process</code>
can also be treated in the same manner, and defined separately in another file.</p>
<ul>
<li>Now it's your turn! Separate the <code>RUN_FASTQC</code> and <code>RUN_MULTIQC</code> processes out
  of the main workflow and into a subworkflow. Check below if you're having
  trouble.</li>
</ul>
<details>
<summary> Click to show </summary>


<pre><code class="language-nextflow">// In the main workflow:
RUN_QC (
    GET_SRA_BY_ACCESSION.out
)

// A new subworkflow
workflow RUN_QC {

    take:
    fastq

    main:
    RUN_FASTQC (
        fastq
    )
    RUN_MULTIQC (
        RUN_FASTQC.out.zip.collect()
    )
}
</code></pre>


</details>

<p>If you want to challenge yourself, try to do the same with the <code>INDEX_GENOME</code>,
<code>ALIGN_TO_GENOME</code> and <code>SORT_BAM</code> processes! Be careful of where you get your
inputs and outputs.</p>
<blockquote>
<p><strong>Quick recap</strong> <br>
In this section we learnt:</p>
<ul>
<li>How to automatically download remote files</li>
<li>How to create and work with subworkflows</li>
</ul>
</blockquote>

			<br>
			






<div class="row pt-2 pb-4">
	<div class="col-sm text-center text-sm-left">
		<a href="../nextflow-5-workflow-configuration/" class="btn btn-sm btn-outline-dark">
			<i class="fa fa-chevron-left" aria-hidden="true"></i>
			Previous
		</a>
		<a href="../nextflow-5-workflow-configuration/" class="btn btn-sm btn-link">
			Configuration
		</a>
	</div>
	

	
	<div class="col-sm text-center text-sm-right">
		<a href="../nextflow-7-extra-material/" class="btn btn-sm btn-link">
			Extra materiel
		</a>
		<a href="../nextflow-7-extra-material/" class="btn btn-sm btn-outline-dark">
			Next
			<i class="fa fa-chevron-right" aria-hidden="true"></i>
		</a>
	</div>
	
</div>

			<br>
		</div>

		<footer class="container-fluid wm-page-content text-center small">
			<p>
			<a href="https://github.com/Juke34/workshop-reproducible-research/edit/master/docs/nextflow/nextflow-6-optimising-the-mrsa-workflow.md" target="_blank">Edit on workshop-reproducible-research</a>
			</p>
			<details>
				<summary>
					Documentation built with <a href="http://www.mkdocs.org/" target="_blank">MkDocs</a> using  <a href="https://github.com/Siphalor/mkdocs-custommill" target="_blank">CustomMill</a>.
				</summary>
				<h6 class="mt-2">Additional Licenses</h6>
				<ul><li>
						CustomMill is based on the <a href="https://github.com/gristlabs/mkdocs-windmill" target="_blank">Windmill</a> theme by Grist Labs, licensed under the <a href="https://github.com/gristlabs/mkdocs-windmill/blob/master/LICENSE" target="_blank">MIT License</a>
					</li>
					<li>
						CustomMill includes <a href="https://getbootstrap.com" target="_blank">Bootstrap</a> version 5.1.3. This is available under the <a href="https://github.com/twbs/bootstrap/blob/master/LICENSE" target="_blank">MIT License</a>.
					</li>
					<li>
						Syntax highlighting is implemented via <a href="https://highlightjs.org" target="_blank">highlight.js</a> licensed under the BSD 3-Clause License and the included github styling made by Vasily Polovnyov.
					</li>
					<li>
						Icons on this site are from <a href="https://fontawesome.com/" target="_blank">Font Awesome</a> which is licensed under the <a href="https://fontawesome.com/license/free" target="_blank">Font Awesome Free License</a>.
					</li></ul>
				<p>Built at 2023-02-10 16:41:13 UTC</p>
			</details>
		</footer>

		
	</body>
</html>