<!DOCTYPE html>
<html lang="en">
	<head>
		
		
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<meta name="author" content="Jacques Dainat et al.">
		<link rel="canonical" href="https://Juke34.github.io/workshop-reproducible-research/snakemake/snakemake-11-extra-material/">
		<link rel="shortcut icon" href="../../img/favicon.ico">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<title>Extra materiel - Bioinformatics Workshop on Tools for Reproducible Research</title>
		<link href="../../bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
		<link href="../../css/font-awesome-5.12.2-all.min.css" rel="stylesheet">
		<link href="../../css/base.css" rel="stylesheet">
		<link rel="stylesheet" href="../../css/highlight-github.css">
		<script src="../../bootstrap/dist/js/bootstrap.min.js"></script>
		<script src="../../js/highlight.pack.js"></script>
		
		<script>
			var base_url = '../..';
			var home_url = '../../usage';
			var is_outer_page = false;
			
			var pageToc = [
				{title: "Using containers in Snakemake", url: "#_top", children: [
				]},
				{title: "Running Snakemake workflows on UPPMAX", url: "#running-snakemake-workflows-on-uppmax", children: [
						
				{title: "Run your workflow in an interactive job", url: "#_top", children: [
				]},
				{title: "Cluster configuration", url: "#cluster-configuration", children: [
				]},
				{title: "SLURM Profile", url: "#slurm-profile", children: [
				]},
				]},
			];

		</script>
		<script src="../../js/base.js"></script> 
	</head>

	<body class="inner-page">
		

		<div class="container-fluid wm-page-content">
			<a name="_top" aria-hidden="true"></a>
			






<div class="row pt-2 pb-4">
	<div class="col-sm text-center text-sm-left">
		<a href="../snakemake-10-generalizing-workflows/" class="btn btn-sm btn-outline-dark">
			<i class="fa fa-chevron-left" aria-hidden="true"></i>
			Previous
		</a>
		<a href="../snakemake-10-generalizing-workflows/" class="btn btn-sm btn-link">
			Generalizing workflows
		</a>
	</div>
	

	
	<div class="col-sm text-center text-sm-right">
		<a href="../../nextflow/nextflow-1-introduction/" class="btn btn-sm btn-link">
			Introduction
		</a>
		<a href="../../nextflow/nextflow-1-introduction/" class="btn btn-sm btn-outline-dark">
			Next
			<i class="fa fa-chevron-right" aria-hidden="true"></i>
		</a>
	</div>
	
</div>

			

			<p>If you want to read more about Snakemake in general you can find several
resources here:</p>
<ul>
<li>The Snakemake documentation is available on <a href="https://snakemake.readthedocs.io/en/stable/#">readthedocs</a>.</li>
<li>Here is another (quite in-depth) <a href="https://snakemake.readthedocs.io/en/stable/tutorial/tutorial.html#tutorial">tutorial</a>.</li>
<li>If you have questions, check out <a href="https://stackoverflow.com/questions/tagged/snakemake">stack overflow</a>.</li>
</ul>
<h1 id="using-containers-in-snakemake">Using containers in Snakemake<a class="headerlink" href="#using-containers-in-snakemake" title="Permanent link">#</a></h1>
<p>Snakemake also supports defining a Singularity or Docker container for each
rule (you will have time to work on the <a href="containers-1-introduction">Containers tutorial</a>
later during the course). Analogous to using a rule-specific Conda environment,
specify <code>container: "docker://some-account/rule-specific-image"</code> in the rule
definition. Instead of a link to a container image, it is also possible to
provide the path to a <code>*.sif</code> file (= a Singularity file). When executing
Snakemake, add the <code>--use-singularity</code> flag to the command line. For the given
rule, a Singularity container will then be created from the image or Singularity
file that is provided in the rule definition on the fly by Snakemake and the
rule will be run in this container.</p>
<p>You can find pre-made Singularity or Docker images for many tools on
<a href="https://biocontainers.pro/">https://biocontainers.pro/</a> (bioinformatics-specific)
or on <a href="https://hub.docker.com/">https://hub.docker.com/</a>.</p>
<p>Here is an example for a rule and its execution:</p>
<pre><code class="language-python">rule align_to_genome:
    &quot;&quot;&quot;
    Align a fastq file to a genome index using Bowtie 2.
    &quot;&quot;&quot;
    input:
        &quot;data/raw_internal/{sample_id}.fastq.gz&quot;,
        &quot;intermediate/NCTC8325.1.bt2&quot;,
        &quot;intermediate/NCTC8325.2.bt2&quot;,
        &quot;intermediate/NCTC8325.3.bt2&quot;,
        &quot;intermediate/NCTC8325.4.bt2&quot;,
        &quot;intermediate/NCTC8325.rev.1.bt2&quot;,
        &quot;intermediate/NCTC8325.rev.2.bt2&quot;
    output:
        &quot;intermediate/{sample_id,\w+}.bam&quot;
    container: &quot;docker://quay.io/biocontainers/bowtie2:2.3.4.1--py35h2d50403_1&quot;
    shell:
        &quot;&quot;&quot;
        bowtie2 -x intermediate/NCTC8325 -U {input[0]} &gt; {output}
        &quot;&quot;&quot;
</code></pre>
<p>Start your Snakemake workflow with the following command:</p>
<pre><code class="language-bash">snakemake --use-singularity
</code></pre>
<p>Feel free to modify the MRSA workflow according to this example. As Singularity
is a container software that was developed for HPC clusters, and for example the
Mac version is still a beta version, it might not work to run your updated
Snakemake workflow with Singularity locally on your computer.
In the next section we explain how you can run Snakemake workflows on UPPMAX
where Singularity is pre-installed.</p>
<h1 id="running-snakemake-workflows-on-uppmax">Running Snakemake workflows on UPPMAX<a class="headerlink" href="#running-snakemake-workflows-on-uppmax" title="Permanent link">#</a></h1>
<p>There are several options to execute Snakemake workflows on UPPMAX (a HPC
cluster with the SLURM workload manager). In any case, we highly recommend to
use a session manager like <code>tmux</code> or <code>screen</code> so that you can run your workflow
in a session in the background while doing other things on the cluster or even
logging out of the cluster.</p>
<h3 id="run-your-workflow-in-an-interactive-job">Run your workflow in an interactive job<a class="headerlink" href="#run-your-workflow-in-an-interactive-job" title="Permanent link">#</a></h3>
<p>For short workflows with only a few rules that need the same compute resources
in terms of CPU (cores), you can start an interactive job (in your <code>tmux</code> or
<code>screen</code> session) and run your Snakemake workflow as you would do that on your
local machine. Make sure to give your interactive job enough time to finish
running all rules of your Snakemake workflow.</p>
<h3 id="cluster-configuration">Cluster configuration<a class="headerlink" href="#cluster-configuration" title="Permanent link">#</a></h3>
<p>For workflows with long run times and/or where each rule requires different
compute resources, Snakemake can be configured to automatically send each rule
as a job to the SLURM queue and to track the status of each job.</p>
<p>The relevant parameters for such a cluster configuration are <code>--cluster</code> and
<code>--cluster-config</code>, in combination with a <code>cluster.yaml</code> file that specifies
default and rule-specific compute resources and your compute account details.</p>
<p>Here is an example for a <code>cluster.yaml</code> file:</p>
<pre><code class="language-yaml"># cluster.yaml - cluster configuration file
__default__:
  account: # fill in your project compute account ID
  partition: core
  time: 01:00:00
  ntasks: 1
  cpus-per-task: 1
### rule-specific resources
trimming:
  time: 01-00:00:00
mapping:
  time: 01-00:00:00
  cpus-per-task: 16
</code></pre>
<p>Start your Snakemake workflow in a <code>tmux</code> or <code>screen</code> session with the
following command:</p>
<pre><code class="language-bash">snakemake
    -j 10 \
    --cluster-config cluster.yaml \
    --cluster &quot;sbatch \
               -A {cluster.account} \
               -p {cluster.partition} \
               -t {cluster.time} \
               --ntasks {cluster.ntasks} \
               --cpus-per-task {cluster.cpus-per-task}&quot;
</code></pre>
<p>The additional parameter <code>-j</code> specifies the number of jobs that Snakemake is
allowed to send to SLURM at the same time.</p>
<h3 id="slurm-profile">SLURM Profile<a class="headerlink" href="#slurm-profile" title="Permanent link">#</a></h3>
<p>The cluster configuration is actually marked as "deprecated" but still exists
side-by-side with the thought to be replacement: <a href="https://snakemake.readthedocs.io/en/stable/executing/cli.html#profiles">profiles</a>.
Snakemake profiles can be used to define several options, allowing you to quickly
adapt a workflow to different use-cases or to different environments. One such
convenient profile is the <a href="https://github.com/Snakemake-Profiles/slurm">SLURM profile</a>
developed to make a workflow make efficient use of the SLURM workload manager
that is used <em>e.g.</em> on Uppmax.</p>
<p>The SLURM Profile needs to be set up with the software
<a href="https://cookiecutter.readthedocs.io/">cookiecutter</a> which you can install with
conda: <code>conda install -c conda-forge cookiecutter</code>.</p>
<p>During the <a href="https://github.com/Snakemake-Profiles/slurm#quickstart">setup</a> of 
the profile you will be asked for several values for your Profile. To configure
the profile to use your account id see <a href="https://github.com/Snakemake-Profiles/slurm#example-1-project-setup-to-use-specific-slurm-account">Example 1: project setup to use specific slurm account</a>
at the profile repository.</p>
<p>Rule-specific resources can be defined in each rule via the <code>resources:</code>
directive, for example:</p>
<pre><code class="language-python">rule align_to_genome:
    input:
        &quot;{genome_id}.bt2&quot;,
        &quot;{sample}.fastq.gz&quot;
    output:
        &quot;{sample}.bam&quot;
    resources:
        runtime = 360
    threads: 10
    shell:
        &quot;&quot;&quot;
        aligner -t {threads} -i {input[1]} -x {input[0]} &gt; {output}
        &quot;&quot;&quot;
</code></pre>
<p>Any rule for which runtime is specified in the <code>resources</code> directive will be
submitted as one job to the SLURM queue with runtime as the allocated time.
Similarly, the number specified in the <code>threads</code> directive will be used as the
number of allocated cores.</p>
<p>With this setup you can start the workflow with your SLURM Profile as follows
from within a <code>tmux</code> or <code>screen</code> session:</p>
<pre><code class="language-bash">snakemake -j 10 --profile your_profile_name
</code></pre>

			<br>
			






<div class="row pt-2 pb-4">
	<div class="col-sm text-center text-sm-left">
		<a href="../snakemake-10-generalizing-workflows/" class="btn btn-sm btn-outline-dark">
			<i class="fa fa-chevron-left" aria-hidden="true"></i>
			Previous
		</a>
		<a href="../snakemake-10-generalizing-workflows/" class="btn btn-sm btn-link">
			Generalizing workflows
		</a>
	</div>
	

	
	<div class="col-sm text-center text-sm-right">
		<a href="../../nextflow/nextflow-1-introduction/" class="btn btn-sm btn-link">
			Introduction
		</a>
		<a href="../../nextflow/nextflow-1-introduction/" class="btn btn-sm btn-outline-dark">
			Next
			<i class="fa fa-chevron-right" aria-hidden="true"></i>
		</a>
	</div>
	
</div>

			<br>
		</div>

		<footer class="container-fluid wm-page-content text-center small">
			<p>
			<a href="https://github.com/Juke34/workshop-reproducible-research/edit/master/docs/snakemake/snakemake-11-extra-material.md" target="_blank">Edit on workshop-reproducible-research</a>
			</p>
			<details>
				<summary>
					Documentation built with <a href="http://www.mkdocs.org/" target="_blank">MkDocs</a> using  <a href="https://github.com/Siphalor/mkdocs-custommill" target="_blank">CustomMill</a>.
				</summary>
				<h6 class="mt-2">Additional Licenses</h6>
				<ul><li>
						CustomMill is based on the <a href="https://github.com/gristlabs/mkdocs-windmill" target="_blank">Windmill</a> theme by Grist Labs, licensed under the <a href="https://github.com/gristlabs/mkdocs-windmill/blob/master/LICENSE" target="_blank">MIT License</a>
					</li>
					<li>
						CustomMill includes <a href="https://getbootstrap.com" target="_blank">Bootstrap</a> version 5.1.3. This is available under the <a href="https://github.com/twbs/bootstrap/blob/master/LICENSE" target="_blank">MIT License</a>.
					</li>
					<li>
						Syntax highlighting is implemented via <a href="https://highlightjs.org" target="_blank">highlight.js</a> licensed under the BSD 3-Clause License and the included github styling made by Vasily Polovnyov.
					</li>
					<li>
						Icons on this site are from <a href="https://fontawesome.com/" target="_blank">Font Awesome</a> which is licensed under the <a href="https://fontawesome.com/license/free" target="_blank">Font Awesome Free License</a>.
					</li></ul>
				<p>Built at 2023-02-10 16:41:13 UTC</p>
			</details>
		</footer>

		
	</body>
</html>