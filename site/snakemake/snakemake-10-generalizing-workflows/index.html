<!DOCTYPE html>
<html lang="en">
	<head>
		
		
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<meta name="author" content="Jacques Dainat et al.">
		<link rel="canonical" href="https://Juke34.github.io/workshop-reproducible-research/snakemake/snakemake-10-generalizing-workflows/">
		<link rel="shortcut icon" href="../../img/favicon.ico">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<title>Generalizing workflows - Bioinformatics Workshop on Tools for Reproducible Research</title>
		<link href="../../bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
		<link href="../../css/font-awesome-5.12.2-all.min.css" rel="stylesheet">
		<link href="../../css/base.css" rel="stylesheet">
		<link rel="stylesheet" href="../../css/highlight-github.css">
		<script src="../../bootstrap/dist/js/bootstrap.min.js"></script>
		<script src="../../js/highlight.pack.js"></script>
		
		<script>
			var base_url = '../..';
			var home_url = '../../usage';
			var is_outer_page = false;
			
			var pageToc = [
			];

		</script>
		<script src="../../js/base.js"></script> 
	</head>

	<body class="inner-page">
		

		<div class="container-fluid wm-page-content">
			<a name="_top" aria-hidden="true"></a>
			






<div class="row pt-2 pb-4">
	<div class="col-sm text-center text-sm-left">
		<a href="../snakemake-9-shadow-rules/" class="btn btn-sm btn-outline-dark">
			<i class="fa fa-chevron-left" aria-hidden="true"></i>
			Previous
		</a>
		<a href="../snakemake-9-shadow-rules/" class="btn btn-sm btn-link">
			Shadow rules
		</a>
	</div>
	

	
	<div class="col-sm text-center text-sm-right">
		<a href="../snakemake-11-extra-material/" class="btn btn-sm btn-link">
			Extra materiel
		</a>
		<a href="../snakemake-11-extra-material/" class="btn btn-sm btn-outline-dark">
			Next
			<i class="fa fa-chevron-right" aria-hidden="true"></i>
		</a>
	</div>
	
</div>

			

			<p>It's generally a good idea to separate project-specific parameters from the
actual implementation of the workflow. If we want to move all project-specific
information to <code>config.yml</code>, and let the Snakefile be a more general RNA-seq
analysis workflow, we need the config file to:</p>
<ul>
<li>Specify which samples to run.</li>
<li>Specify which genome to align to and where to download its sequence and
  annotation files.</li>
<li>(Any other parameters we might need to make it into a general workflow,
  <em>e.g.</em> to support both paired-end and single-read sequencing)</li>
</ul>
<blockquote>
<p><strong>Note</strong> <br>
Putting all configuration in <code>config.yml</code> will break the
<code>generate_rulegraph</code> rule. You can fix it either by replacing
<code>--config max_reads=0</code> with <code>--configfile=config.yml</code> in the shell
command of that rule in the Snakefile, or by adding
<code>configfile: "config.yml"</code> to the top of the Snakefile (as mentioned
in a previous tip).</p>
</blockquote>
<p>The first point is straightforward; rather than using <code>SAMPLES = ["..."]</code> in
the Snakefile we define it as a parameter in <code>config.yml</code>. You can either add
it as a list similar to the way it was expressed before by adding
 <code>SAMPLES: ["..."]</code> to <code>config.yml</code>, or you can use this yaml notation:</p>
<pre><code class="language-yaml">sample_ids:
- SRR935090
- SRR935091
- SRR935092
</code></pre>
<p>You also have to change the workflow to reference <code>config["sample_ids"]</code> (if 
using the latter example) instead of <code>SAMPLES</code>, as in:</p>
<pre><code class="language-bash">expand(&quot;intermediate/{sample_id}_fastqc.zip&quot;,
            sample_id = config[&quot;sample_ids&quot;])
</code></pre>
<p>Do a dry-run afterwards to make sure that everything works as expected.</p>
<p>The second point is trickier. Writing workflows in Snakemake is quite
straightforward when the logic of the workflow is reflected in the file names,
<em>i.e.</em> <code>my_sample.trimmed.deduplicated.sorted.fastq</code>, but that isn't always the
case. In our case we have the FTP paths to the genome sequence and annotation
where the naming doesn't quite fit with the rest of the workflow. The easiest
solution is probably to make three parameters to hold these values, say
<code>genome_id</code>, <code>genome_fasta_path</code> and <code>genome_gff_path</code>, but we will go for
a somewhat more complex but very useful alternative. We want to construct
a dictionary where something that will be a wildcard in the workflow is the key
and the troublesome name is the value. An example might make this clearer (this
is also in <code>config.yml</code> in the finished version of the workflow under 
<code>tutorials/git/</code>). This is a nested dictionary where "genomes" is a key with 
another dictionary as value, which in turn has genome ids as keys and so on. The
idea is that we have a wildcard in the workflow that takes the id of a genome as
value (either "NCTC8325" or "ST398" in this case). The fasta and gff3 paths can 
then be retrieved based on the value of the wildcard.</p>
<pre><code class="language-yaml">genomes:
  NCTC8325:
    fasta: ftp://ftp.ensemblgenomes.org/pub/bacteria/release-37/fasta/bacteria_18_collection/staphylococcus_aureus_subsp_aureus_nctc_8325/dna//Staphylococcus_aureus_subsp_aureus_nctc_8325.ASM1342v1.dna_rm.toplevel.fa.gz
    gff3: ftp://ftp.ensemblgenomes.org/pub/bacteria/release-37/gff3/bacteria_18_collection/staphylococcus_aureus_subsp_aureus_nctc_8325//Staphylococcus_aureus_subsp_aureus_nctc_8325.ASM1342v1.37.gff3.gz
  ST398:
    fasta: ftp://ftp.ensemblgenomes.org/pub/bacteria/release-37/fasta/bacteria_18_collection//staphylococcus_aureus_subsp_aureus_st398/dna/Staphylococcus_aureus_subsp_aureus_st398.ASM958v1.dna.toplevel.fa.gz
    gff3: ftp://ftp.ensemblgenomes.org/pub/bacteria/release-37/gff3/bacteria_18_collection/staphylococcus_aureus_subsp_aureus_st398//Staphylococcus_aureus_subsp_aureus_st398.ASM958v1.37.gff3.gz
</code></pre>
<p>Go ahead and add the section above to <code>config.yml</code>. </p>
<p>Let's now look at how to do the mapping from genome id to fasta path in the
rule <code>get_genome_fasta</code>. This is how the rule currently looks (if you have
added the log section as previously described).</p>
<pre><code class="language-python">rule get_genome_fasta:
    &quot;&quot;&quot;
    Retrieve the sequence in fasta format for a genome.
    &quot;&quot;&quot;
    output:
        &quot;data/raw_external/NCTC8325.fa.gz&quot;
    log:
        &quot;results/logs/get_genome_fasta/NCTC8325.log&quot;
    shell:
        &quot;&quot;&quot;
        wget ftp://ftp.ensemblgenomes.org/pub/bacteria/release-37/fasta/bacteria_18_collection/staphylococcus_aureus_subsp_aureus_nctc_8325/dna//Staphylococcus_aureus_subsp_aureus_nctc_8325.ASM1342v1.dna_rm.toplevel.fa.gz -O {output} -o {log}
        &quot;&quot;&quot;
</code></pre>
<p>We don't want the hardcoded genome id <code>NCTC8325</code>, so replace that with a 
wildcard, say <code>{genome_id}</code> (remember to add the wildcard to the <code>log:</code> 
directive as well). </p>
<p>Also change in <code>index_genome</code> to use a wildcard rather than a hardcoded genome
id. Here you will run into a complication if you have followed the previous
instructions and use the <code>expand()</code> expression. We want the list to expand to
<code>["intermediate/{genome_id}.1.bt2", "intermediate/{genome_id}.2.bt2", ...]</code>,
<em>i.e.</em> only expanding the wildcard referring to the bowtie2 index. To keep the
<code>genome_id</code> wildcard from being expanded we have to "mask" it with double curly
brackets: <code>{{genome_id}}</code>. In addition, we need to replace the hardcoded 
<code>intermediate/NCTC8325</code> in the shell directive of the rule with the genome id 
wildcard. Inside the shell directive the wildcard object is accessed with this 
syntax: <code>{wildcards.genome_id}</code>, so the bowtie2-build command should be:</p>
<pre><code class="language-bash">bowtie2-build tempfile intermediate/{wildcards.genome_id} &gt; {log}
</code></pre>
<p>We now need to supply the remote paths to the fasta and gff files for a given 
genome id. Because we've added this information to the config file we just need 
to pass it to the rule in some way.</p>
<p>Take a look at the code and <code>get_genome_fasta</code> rule below. Here we have defined 
a function called <code>get_fasta_path</code> which takes the <code>wildcards</code> object as its 
only argument. This object allows access to the wildcards values via attributes 
(here <code>wildcards.genome_id</code>). The function will then look in the nested <code>config</code> 
dictionary and return the value of the fasta path for the key 
<code>wildcards.genome_id</code>. In the rule this path is stored in the <code>fasta_path</code> param
value and is made available to <code>wget</code> in the shell directive. </p>
<pre><code class="language-python">def get_fasta_path(wildcards):
    return config[&quot;genomes&quot;][wildcards.genome_id][&quot;fasta&quot;]

rule get_genome_fasta:
    &quot;&quot;&quot;
    Retrieve the sequence in fasta format for a genome.
    &quot;&quot;&quot;
    output:
        &quot;data/raw_external/{genome_id}.fa.gz&quot;
    log:
        &quot;results/logs/get_genome_fasta/{genome_id}.log&quot;
    params:
        fasta_path = get_fasta_path
    shell:
        &quot;&quot;&quot;
        wget {params.fasta_path} -O {output} -o {log}
        &quot;&quot;&quot;
</code></pre>
<p>Note that this will only work if the <code>{genome_id}</code> wildcard can be resolved to
something defined in the config (currently <code>NCTC8325</code> or <code>ST398</code>). If you try to
generate a fasta file for a genome id not defined in the config Snakemake will 
complain, even at the dry-run stage.</p>
<p>Now change the <code>get_genome_gff3</code> rule in a similar manner.</p>
<p>The rules <code>get_genome_fasta</code>, <code>get_genome_gff3</code> and <code>index_genome</code> can now 
download and index <em>any genome</em> as long as we provide valid links in the config
file. </p>
<p>However, we need to define somewhere which genome id we actually want to use
when running the workflow. This needs to be done both in <code>align_to_genome</code> and
<code>generate_count_table</code>. Do this by introducing a parameter in <code>config.yml</code> 
called <code>"genome_id"</code> (you can set it to either <code>NCTC8325</code> or <code>ST398</code>). </p>
<p>Now we can resolve the <code>genome_id</code> wildcard from the config. See below for an 
example for <code>align_to_genome</code>. Here the <code>substr</code> wildcard gets expanded from a 
list while <code>genome_id</code> gets expanded from the config file.</p>
<pre><code class="language-python">input:
    index = expand(&quot;intermediate/{genome_id}.{substr}.bt2&quot;,
           genome_id = config[&quot;genome_id&quot;],
           substr = [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;rev.1&quot;, &quot;rev.2&quot;])
</code></pre>
<p>Also change the hardcoded genome id in the <code>generate_count_table</code> input in a 
similar manner.</p>
<p>In general, we want the rules as far downstream as possible in the workflow to 
be the ones that determine what the wildcards should resolve to. In our case 
this is <code>align_to_genome</code> and <code>generate_count_table</code>. You can think of it like 
the rule that really "needs" the file asks for it, and then it's up to Snakemake
to determine how it can use all the available rules to generate it. Here the 
<code>align_to_genome</code> rule says "I need this genome index to align my sample to" and
then it's up to Snakemake to determine how to download and build the index.</p>
<p>One last thing is to change the hardcoded <code>NCTC8325</code> in the <code>shell:</code> directive
of <code>align_to_genome</code>. Bowtie2 expects the index name supplied with the <code>-x</code> flag
to be without the ".*.bt2" suffix so we can't use <code>-x {input.index}</code>. Instead 
we'll insert the genome_id directly from the config like this:</p>
<pre><code class="language-bash">shell:
    &quot;&quot;&quot;  
    bowtie2 -x intermediate/{config[genome_id]} -U {input[0]} &gt; {output} 2&gt;{log}
    &quot;&quot;&quot;
</code></pre>
<blockquote>
<p><strong>Summary</strong> <br>
Well done! You now have a complete Snakemake workflow with a number of
excellent features:</p>
<ul>
<li>A general RNA-seq pipeline which can easily be reused between projects,
  thanks to clear separation between code and settings.</li>
<li>Great traceability due to logs and summary tables.</li>
<li>Clearly defined the environment for the workflow using Conda.</li>
<li>The workflow is neat and free from temporary files due to using <code>temp()</code> and
  <code>shadow</code>.</li>
<li>A logical directory structure which makes it easy to separate raw data,
  intermediate files, and results.</li>
<li>A project set up in a way that makes it very easy to distribute and
  reproduce either via Git, Snakemake's <code>--archive</code> option or a Docker image.</li>
</ul>
<p><strong>Quick recap</strong> <br>
In this section we've learned:</p>
<ul>
<li>How to generalize a Snakemake workflow.</li>
</ul>
</blockquote>

			<br>
			






<div class="row pt-2 pb-4">
	<div class="col-sm text-center text-sm-left">
		<a href="../snakemake-9-shadow-rules/" class="btn btn-sm btn-outline-dark">
			<i class="fa fa-chevron-left" aria-hidden="true"></i>
			Previous
		</a>
		<a href="../snakemake-9-shadow-rules/" class="btn btn-sm btn-link">
			Shadow rules
		</a>
	</div>
	

	
	<div class="col-sm text-center text-sm-right">
		<a href="../snakemake-11-extra-material/" class="btn btn-sm btn-link">
			Extra materiel
		</a>
		<a href="../snakemake-11-extra-material/" class="btn btn-sm btn-outline-dark">
			Next
			<i class="fa fa-chevron-right" aria-hidden="true"></i>
		</a>
	</div>
	
</div>

			<br>
		</div>

		<footer class="container-fluid wm-page-content text-center small">
			<p>
			<a href="https://github.com/Juke34/workshop-reproducible-research/edit/master/docs/snakemake/snakemake-10-generalizing-workflows.md" target="_blank">Edit on workshop-reproducible-research</a>
			</p>
			<details>
				<summary>
					Documentation built with <a href="http://www.mkdocs.org/" target="_blank">MkDocs</a> using  <a href="https://github.com/Siphalor/mkdocs-custommill" target="_blank">CustomMill</a>.
				</summary>
				<h6 class="mt-2">Additional Licenses</h6>
				<ul><li>
						CustomMill is based on the <a href="https://github.com/gristlabs/mkdocs-windmill" target="_blank">Windmill</a> theme by Grist Labs, licensed under the <a href="https://github.com/gristlabs/mkdocs-windmill/blob/master/LICENSE" target="_blank">MIT License</a>
					</li>
					<li>
						CustomMill includes <a href="https://getbootstrap.com" target="_blank">Bootstrap</a> version 5.1.3. This is available under the <a href="https://github.com/twbs/bootstrap/blob/master/LICENSE" target="_blank">MIT License</a>.
					</li>
					<li>
						Syntax highlighting is implemented via <a href="https://highlightjs.org" target="_blank">highlight.js</a> licensed under the BSD 3-Clause License and the included github styling made by Vasily Polovnyov.
					</li>
					<li>
						Icons on this site are from <a href="https://fontawesome.com/" target="_blank">Font Awesome</a> which is licensed under the <a href="https://fontawesome.com/license/free" target="_blank">Font Awesome Free License</a>.
					</li></ul>
				<p>Built at 2023-02-10 16:41:13 UTC</p>
			</details>
		</footer>

		
	</body>
</html>