<!DOCTYPE html>
<html lang="en">
	<head>
		
		
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<meta name="author" content="Jacques Dainat et al.">
		<link rel="canonical" href="https://Juke34.github.io/workshop-reproducible-research/snakemake/snakemake-9-shadow-rules/">
		<link rel="shortcut icon" href="../../img/favicon.ico">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<title>Shadow rules - Bioinformatics Workshop on Tools for Reproducible Research</title>
		<link href="../../bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
		<link href="../../css/font-awesome-5.12.2-all.min.css" rel="stylesheet">
		<link href="../../css/base.css" rel="stylesheet">
		<link rel="stylesheet" href="../../css/highlight-github.css">
		<script src="../../bootstrap/dist/js/bootstrap.min.js"></script>
		<script src="../../js/highlight.pack.js"></script>
		
		<script>
			var base_url = '../..';
			var home_url = '../../usage';
			var is_outer_page = false;
			
			var pageToc = [
			];

		</script>
		<script src="../../js/base.js"></script> 
	</head>

	<body class="inner-page">
		

		<div class="container-fluid wm-page-content">
			<a name="_top" aria-hidden="true"></a>
			






<div class="row pt-2 pb-4">
	<div class="col-sm text-center text-sm-left">
		<a href="../snakemake-8-targets/" class="btn btn-sm btn-outline-dark">
			<i class="fa fa-chevron-left" aria-hidden="true"></i>
			Previous
		</a>
		<a href="../snakemake-8-targets/" class="btn btn-sm btn-link">
			Targets
		</a>
	</div>
	

	
	<div class="col-sm text-center text-sm-right">
		<a href="../snakemake-10-generalizing-workflows/" class="btn btn-sm btn-link">
			Generalizing workflows
		</a>
		<a href="../snakemake-10-generalizing-workflows/" class="btn btn-sm btn-outline-dark">
			Next
			<i class="fa fa-chevron-right" aria-hidden="true"></i>
		</a>
	</div>
	
</div>

			

			<p>Take a look at the <code>index_genome</code> rule below:</p>
<pre><code class="language-python">rule index_genome:
    &quot;&quot;&quot;
    Index a genome using Bowtie 2.
    &quot;&quot;&quot;
    output:
        index = expand(&quot;intermediate/NCTC8325.{substr}.bt2&quot;,
           substr = [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;rev.1&quot;, &quot;rev.2&quot;])
    input:
        &quot;data/raw_external/NCTC8325.fa.gz&quot;
    log:
        &quot;results/logs/index_genome/NCTC8325.log&quot;
    shell:
        &quot;&quot;&quot;
        # Bowtie2 cannot use .gz, so unzip to a temporary file first
        gunzip -c {input} &gt; tempfile
        bowtie2-build tempfile intermediate/NCTC8325 &gt;{log}

        # Remove the temporary file
        rm tempfile
        &quot;&quot;&quot;
</code></pre>
<p>There is a temporary file here called <code>tempfile</code> which is the uncompressed
version of the input, since Bowtie 2 cannot use compressed files. There are
a number of drawbacks with having files that aren't explicitly part of the
workflow as input/output files to rules:</p>
<ul>
<li>Snakemake cannot clean up these files if the job fails, as it would do for
  normal output files.</li>
<li>If several jobs are run in parallel there is a risk that they write to
  <code>tempfile</code> at the same time. This can lead to very scary results.</li>
<li>Sometimes we don't know the names of all the files that a program can
  generate. It is, for example, not unusual that programs leave some kind of
  error log behind if something goes wrong.</li>
</ul>
<p>All of these issues can be dealt with by using the <code>shadow</code> option for a rule.
The shadow option results in that each execution of the rule is run in an
isolated temporary directory (located in <code>.snakemake/shadow/</code> by default).
There are a few options for <code>shadow</code> (for the full list of these options see
the <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#shadow-rules">Snakemake docs</a>).
The most simple is <code>shadow: "minimal"</code>, which means that the rule is executed in
an empty directory that the input files to the rule have been symlinked into. 
For the rule below, that means that the only file available would be <code>input.txt</code>. 
The shell commands would generate the files <code>some_other_junk_file</code> and 
<code>output.txt</code>. Lastly, Snakemake will move the output file (<code>output.txt</code>) to its 
"real" location and remove the whole shadow directory. We therefore never have 
to think about manually removing <code>some_other_junk_file</code>.</p>
<pre><code class="language-python">rule some_rule:
    output:
        &quot;output.txt&quot;
    input:
        &quot;input.txt&quot;
    shadow: &quot;minimal&quot;
    shell:
        &quot;&quot;&quot;
        touch some_other_junk_file
        cp {input} {output}
        &quot;&quot;&quot;
</code></pre>
<p>Try this out for the rules where we have to "manually" deal with files that
aren't tracked by Snakemake (<code>multiqc</code>, <code>index_genome</code>). Also remove the shell
commands that remove temporary files from those rules, as they are no longer
needed. Now rerun the workflow and validate that the temporary files don't show
up in your working directory.</p>
<blockquote>
<p><strong>Tip</strong> <br>
Some people use the shadow option for almost every rule and some never
use it at all. One thing to keep in mind is that it leads to some extra file
operations when the outputs are moved to their final location. This is no
issue when the shadow directory is on the same disk as the output directory,
but if you're running on a distributed file system and generate very many
or very large files it might be worth considering other options (see <em>e.g.</em>
the <code>--shadow-prefix</code> flag).</p>
<p><strong>Quick recap</strong> <br>
In this section we've learned:</p>
<ul>
<li>How to use the shadow option to handle files that are not tracked by Snakemake.</li>
</ul>
</blockquote>

			<br>
			






<div class="row pt-2 pb-4">
	<div class="col-sm text-center text-sm-left">
		<a href="../snakemake-8-targets/" class="btn btn-sm btn-outline-dark">
			<i class="fa fa-chevron-left" aria-hidden="true"></i>
			Previous
		</a>
		<a href="../snakemake-8-targets/" class="btn btn-sm btn-link">
			Targets
		</a>
	</div>
	

	
	<div class="col-sm text-center text-sm-right">
		<a href="../snakemake-10-generalizing-workflows/" class="btn btn-sm btn-link">
			Generalizing workflows
		</a>
		<a href="../snakemake-10-generalizing-workflows/" class="btn btn-sm btn-outline-dark">
			Next
			<i class="fa fa-chevron-right" aria-hidden="true"></i>
		</a>
	</div>
	
</div>

			<br>
		</div>

		<footer class="container-fluid wm-page-content text-center small">
			<p>
			<a href="https://github.com/Juke34/workshop-reproducible-research/edit/master/docs/snakemake/snakemake-9-shadow-rules.md" target="_blank">Edit on workshop-reproducible-research</a>
			</p>
			<details>
				<summary>
					Documentation built with <a href="http://www.mkdocs.org/" target="_blank">MkDocs</a> using  <a href="https://github.com/Siphalor/mkdocs-custommill" target="_blank">CustomMill</a>.
				</summary>
				<h6 class="mt-2">Additional Licenses</h6>
				<ul><li>
						CustomMill is based on the <a href="https://github.com/gristlabs/mkdocs-windmill" target="_blank">Windmill</a> theme by Grist Labs, licensed under the <a href="https://github.com/gristlabs/mkdocs-windmill/blob/master/LICENSE" target="_blank">MIT License</a>
					</li>
					<li>
						CustomMill includes <a href="https://getbootstrap.com" target="_blank">Bootstrap</a> version 5.1.3. This is available under the <a href="https://github.com/twbs/bootstrap/blob/master/LICENSE" target="_blank">MIT License</a>.
					</li>
					<li>
						Syntax highlighting is implemented via <a href="https://highlightjs.org" target="_blank">highlight.js</a> licensed under the BSD 3-Clause License and the included github styling made by Vasily Polovnyov.
					</li>
					<li>
						Icons on this site are from <a href="https://fontawesome.com/" target="_blank">Font Awesome</a> which is licensed under the <a href="https://fontawesome.com/license/free" target="_blank">Font Awesome Free License</a>.
					</li></ul>
				<p>Built at 2023-02-10 16:41:13 UTC</p>
			</details>
		</footer>

		
	</body>
</html>