<!DOCTYPE html>
<html lang="en">
	<head>
		
		
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<meta name="author" content="Jacques Dainat et al.">
		<link rel="canonical" href="https://Juke34.github.io/workshop-reproducible-research/snakemake/snakemake-3-visualising-workflows/">
		<link rel="shortcut icon" href="../../img/favicon.ico">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<title>Visualising workflow - Bioinformatics Workshop on Tools for Reproducible Research</title>
		<link href="../../bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
		<link href="../../css/font-awesome-5.12.2-all.min.css" rel="stylesheet">
		<link href="../../css/base.css" rel="stylesheet">
		<link rel="stylesheet" href="../../css/highlight-github.css">
		<script src="../../bootstrap/dist/js/bootstrap.min.js"></script>
		<script src="../../js/highlight.pack.js"></script>
		
		<script>
			var base_url = '../..';
			var home_url = '../../usage';
			var is_outer_page = false;
			
			var pageToc = [
			];

		</script>
		<script src="../../js/base.js"></script> 
	</head>

	<body class="inner-page">
		

		<div class="container-fluid wm-page-content">
			<a name="_top" aria-hidden="true"></a>
			






<div class="row pt-2 pb-4">
	<div class="col-sm text-center text-sm-left">
		<a href="../snakemake-2-the-basics/" class="btn btn-sm btn-outline-dark">
			<i class="fa fa-chevron-left" aria-hidden="true"></i>
			Previous
		</a>
		<a href="../snakemake-2-the-basics/" class="btn btn-sm btn-link">
			The basics
		</a>
	</div>
	

	
	<div class="col-sm text-center text-sm-right">
		<a href="../snakemake-4-the-mrsa-workflow/" class="btn btn-sm btn-link">
			The MRSA Workflow
		</a>
		<a href="../snakemake-4-the-mrsa-workflow/" class="btn btn-sm btn-outline-dark">
			Next
			<i class="fa fa-chevron-right" aria-hidden="true"></i>
		</a>
	</div>
	
</div>

			

			<p>All that we've done so far could quite easily be done in a simple shell script
that takes the input files as parameters. Let's now take a look at some of the
features where a WfMS like Snakemake really adds value compared to a more
straightforward approach. One such feature is the possibility to visualize your
workflow. Snakemake can generate three types of graphs, one that shows how the
rules are connected, one that shows how the jobs (<em>i.e.</em> an execution of
a rule with some given inputs/outputs/settings) are connected, and finally one
that shows rules with their respective input/output files.</p>
<p>First we look at the rule graph. The following command will generate a rule graph
in the dot language and pipe it to the program <code>dot</code>, which in turn will save
a visualization of the graph as a PNG file (if you're having troubles displaying
PNG files you could use SVG or JPG instead).</p>
<pre><code class="language-bash">snakemake --rulegraph a_b.txt | dot -Tpng &gt; rulegraph.png
</code></pre>
<p><img alt="" src="images/rulegraph.svg" /></p>
<p>This looks simple enough, the output from the rule <code>convert_to_upper_case</code> will
be used as input to the rule <code>concatenate_files</code>.</p>
<p>For a more typical bioinformatics project it can look something like this when you
include all the rules from processing of the raw data to generating figures for the paper.</p>
<p><img alt="" src="images/rulegraph_complex.svg" /></p>
<p>While saying that it's easy to read might be a bit of a stretch, it definitely
gives you a better overview of the project than you would have without a WfMS.</p>
<p>The second type of graph is based on the jobs, and looks like this for our
little workflow (use <code>--dag</code> instead of <code>--rulegraph</code>).</p>
<pre><code class="language-bash">snakemake --dag a_b.txt | dot -Tpng &gt; jobgraph.png
</code></pre>
<p><img alt="" src="images/jobgraph.svg" /></p>
<p>The main difference here is that now each node is a job instead of a rule. You
can see that the wildcards used in each job are also displayed. Another
difference is the dotted lines around the nodes. A dotted line is Snakemake's
way of indicating that this rule doesn't need to be rerun in order to generate
<code>a_b.txt</code>. Validate this by running <code>snakemake -n -r a_b.txt</code> and it should say
that there is nothing to be done.</p>
<p>We've discussed before that one of the main purposes of using a WfMS is that it
automatically makes sure that everything is up to date. This is done by
recursively checking that outputs are always newer than inputs for all the
rules involved in the generation of your target files. Now try to change the
contents of <code>a.txt</code> to some other text and save it. What do you think will
happen if you run <code>snakemake -n -r a_b.txt</code> again?</p>
<details>
<summary> Click to show </summary>


<pre><code class="language-no-highlight">$ snakemake -n -r a_b.txt

Building DAG of jobs...
Job stats:
job                      count    min threads    max threads
---------------------  -------  -------------  -------------
concatenate_files            1              1              1
convert_to_upper_case        1              1              1
total                        2              1              1


[Mon Oct 25 17:00:02 2021]
rule convert_to_upper_case:
    input: a.txt
    output: a.upper.txt
    jobid: 1
    reason: Updated input files: a.txt
    wildcards: some_name=a
    resources: tmpdir=/var/folders/p0/6z00kpv16qbf_bt52y4zz2kc0000gp/T


[Mon Oct 25 17:00:02 2021]
rule concatenate_files:
    input: a.upper.txt, b.upper.txt
    output: a_b.txt
    jobid: 0
    reason: Input files updated by another job: a.upper.txt
    wildcards: first=a, second=b
    resources: tmpdir=/var/folders/p0/6z00kpv16qbf_bt52y4zz2kc0000gp/T

Job stats:
job                      count    min threads    max threads
---------------------  -------  -------------  -------------
concatenate_files            1              1              1
convert_to_upper_case        1              1              1
total                        2              1              1

This was a dry-run (flag -n). The order of jobs does not reflect the order of execution.
</code></pre>


</details>

<p>Were you correct? Also generate the job graph and compare to the one generated
above. What's the difference? Now rerun without <code>-n</code> and validate that
<code>a_b.txt</code> contains the new text (don't forget to specify <code>-c 1</code>). Note that
Snakemake doesn't look at the contents of files when trying to determine what has
changed, only at the timestamp for when they were last modified.</p>
<p>We've seen that Snakemake keeps track of if files in the workflow have changed,
and automatically makes sure that any results depending on such files are
regenerated. What about if the rules themselves are changed? It turns out that
since version 7.8.0 Snakemake keeps track of this automatically. </p>
<p>Let's say that we want to modify the rule <code>concatenate_files</code> to also include 
which files were concatenated.</p>
<pre><code class="language-python">rule concatenate_files:
    output:
        &quot;{first}_{second}.txt&quot;
    input:
        &quot;{first}.upper.txt&quot;,
        &quot;{second}.upper.txt&quot;
    shell:
        &quot;&quot;&quot;
        echo 'Concatenating {input}' | cat - {input[0]} {input[1]} &gt; {output}
        &quot;&quot;&quot;
</code></pre>
<blockquote>
<p><strong>Note</strong> <br>
It's not really important for the tutorial, but the shell command used here
first outputs "Concatenating " followed by a space delimited list of the
files in <code>input</code>. This string is then sent to the program <code>cat</code> where it's
concatenated with <code>input[0]</code> and <code>input[1]</code> (the parameter <code>-</code> means that
it should read from standard input). Lastly, the output from <code>cat</code> is sent
to <code>{output}</code>.</p>
</blockquote>
<p>If you now run the workflow as before you should see:</p>
<pre><code class="language-bash">rule concatenate_files:
    input: a.upper.txt, b.upper.txt
    output: a_b.txt
    jobid: 0
    reason: Code has changed since last execution
    wildcards: first=a, second=b
</code></pre>
<p>because although no files involved in the workflow have been changed, Snakemake
recognizes that the workflow code itself has been modified and this triggers
a re-run.</p>
<p>Snakemake is aware of changes to four categories of such "rerun-triggers": 
"input" (changes to rule input files), "params" (changes to the rule <code>params</code> section),
"software-env" (changes to conda environment files specified by the <code>conda:</code> 
directive) and "code" (changes to code in the <code>shell:</code>, <code>run:</code>, <code>script:</code> and 
<code>notebook:</code> directives). </p>
<p>Prior to version 7.8.0, only changes to the modification time of input files would
trigger automatic re-runs. To run Snakemake with this previous behaviour you 
can use the setting <code>--rerun-triggers mtime</code> at the command line. 
Change the <code>shell:</code> section of the <code>concatenate_files</code> rule back to the previous
version, then try running: <code>snakemake -n -r a_b.txt --rerun-triggers mtime</code> and 
you should again see <code>Nothing to be done (all requested files are present and up to date).</code></p>
<p>You can also export information on how all files were generated (when, by which 
rule, which version of the rule, and by which commands) to a tab-delimited file 
like this:</p>
<pre><code class="language-bash">snakemake a_b.txt -c 1 -D &gt; summary.tsv
</code></pre>
<p>The content of <code>summary.tsv</code> is shown in the table below:</p>
<table class="table table-hover table-condensed" border=1; style="margin-left:auto; margin-right:auto;">
    <thead style="background-color:#DAE7F1">
        <tr>
            <td style="padding:5px"> <font size="3"><b> output_file </b> </td>
            <td style="padding:5px"> <font size="3"><b> date </b> </td>
            <td style="padding:5px"> <font size="3"><b> rule </b> </td>
            <td style="padding:5px"> <font size="3"><b> version </b> </td>
            <td style="padding:5px"> <font size="3"><b> log-file(s) </b> </td>
            <td style="padding:5px"> <font size="3"><b> input-file(s) </b> </td>
            <td style="padding:5px"> <font size="3"><b> shellcmd </b> </td>
            <td style="padding:5px"> <font size="3"><b> status </b> </td>
            <td style="padding:5px"> <font size="3"><b> plan </b> </td>
        </tr>
    </thead>
    <tr>
        <td style="padding:5px"> <font size="3"> a_b.txt </td>
        <td style="padding:5px"> <font size="3"> Mon Oct 25 17:01:46 2021 </td>
        <td style="padding:5px"> <font size="3"> concatenate_files </td>
        <td style="padding:5px"> <font size="3"> - </td>
        <td style="padding:5px"> <font size="3"> </td>
        <td style="padding:5px"> <font size="3"> a.upper.txt,b.upper.txt </td>
        <td style="padding:5px"> <font size="3"> cat a.upper.txt b.upper.txt > a_b.txt </td>
        <td style="padding:5px"> <font size="3"> rule implementation changed </td>
        <td style="padding:5px"> <font size="3"> update pending </td>
    </tr>
    <tr>
        <td style="padding:5px"> <font size="3"> a.upper.txt</td>
        <td style="padding:5px"> <font size="3"> Mon Oct 25 17:01:46 2021 </td>
        <td style="padding:5px"> <font size="3"> convert_to_upper_case </td>
        <td style="padding:5px"> <font size="3"> - </td>
        <td style="padding:5px"> <font size="3"> </td>
        <td style="padding:5px"> <font size="3"> a.txt </td>
        <td style="padding:5px"> <font size="3"> tr [a-z] [A-Z] < a.txt > a.upper.txt </td>
        <td style="padding:5px"> <font size="3"> ok </td>
        <td style="padding:5px"> <font size="3"> no update  </td>
    </tr>
    <tr>
        <td style="padding:5px"> <font size="3"> b.upper.txt</td>
        <td style="padding:5px"> <font size="3"> Mon Oct 25 17:01:46 2021 </td>
        <td style="padding:5px"> <font size="3"> convert_to_upper_case </td>
        <td style="padding:5px"> <font size="3"> - </td>
        <td style="padding:5px"> <font size="3"> </td>
        <td style="padding:5px"> <font size="3"> b.txt </td>
        <td style="padding:5px"> <font size="3"> tr [a-z] [A-Z] < b.txt > b.upper.txt </td>
        <td style="padding:5px"> <font size="3"> ok </td>
        <td style="padding:5px"> <font size="3"> no update  </td>
    </tr>
</table>

<p>You can see in the second last column that the rule implementation for <code>a_b.txt</code>
has changed. The last column shows if Snakemake plans to regenerate the files
when it's next executed. You can see that for the <code>concatenate_files</code> the plan
is <code>update pending</code> because we generated the summary with the default behaviour 
of using all rerun-triggers. </p>
<p>You might wonder where Snakemake keeps track of all these things? It stores all
information in a hidden subdirectory called <code>.snakemake</code>. This is convenient
since it's easy to delete if you don't need it anymore and everything is
contained in the project directory. Just be sure to add it to <code>.gitignore</code> so
that you don't end up tracking it with git.</p>
<p>By now you should be familiar with the basic functionality of Snakemake, and
you can build advanced workflows with only the features we have discussed here.
There's a lot we haven't covered though, in particular when it comes to making
your workflow more reusable. In the following section we will start with
a workflow that is fully functional but not very flexible. We will then
gradually improve it, and at the same time showcase some Snakemake features
we haven't discussed yet. Note that this can get a little complex at times, so
if you felt that this section was a struggle then you could move on to one of
the other tutorials instead.</p>
<blockquote>
<p><strong>Quick recap</strong> <br>
In this section we've learned:</p>
<ul>
<li>How to use <code>--dag</code> and <code>--rulegraph</code> for visualizing the job and rule
  graphs, respectively.</li>
<li>How Snakemake reruns relevant parts of the workflow after
  there have been changes.</li>
<li>How Snakemake tracks changes to files and code in a workflow</li>
</ul>
</blockquote>

			<br>
			






<div class="row pt-2 pb-4">
	<div class="col-sm text-center text-sm-left">
		<a href="../snakemake-2-the-basics/" class="btn btn-sm btn-outline-dark">
			<i class="fa fa-chevron-left" aria-hidden="true"></i>
			Previous
		</a>
		<a href="../snakemake-2-the-basics/" class="btn btn-sm btn-link">
			The basics
		</a>
	</div>
	

	
	<div class="col-sm text-center text-sm-right">
		<a href="../snakemake-4-the-mrsa-workflow/" class="btn btn-sm btn-link">
			The MRSA Workflow
		</a>
		<a href="../snakemake-4-the-mrsa-workflow/" class="btn btn-sm btn-outline-dark">
			Next
			<i class="fa fa-chevron-right" aria-hidden="true"></i>
		</a>
	</div>
	
</div>

			<br>
		</div>

		<footer class="container-fluid wm-page-content text-center small">
			<p>
			<a href="https://github.com/Juke34/workshop-reproducible-research/edit/master/docs/snakemake/snakemake-3-visualising-workflows.md" target="_blank">Edit on workshop-reproducible-research</a>
			</p>
			<details>
				<summary>
					Documentation built with <a href="http://www.mkdocs.org/" target="_blank">MkDocs</a> using  <a href="https://github.com/Siphalor/mkdocs-custommill" target="_blank">CustomMill</a>.
				</summary>
				<h6 class="mt-2">Additional Licenses</h6>
				<ul><li>
						CustomMill is based on the <a href="https://github.com/gristlabs/mkdocs-windmill" target="_blank">Windmill</a> theme by Grist Labs, licensed under the <a href="https://github.com/gristlabs/mkdocs-windmill/blob/master/LICENSE" target="_blank">MIT License</a>
					</li>
					<li>
						CustomMill includes <a href="https://getbootstrap.com" target="_blank">Bootstrap</a> version 5.1.3. This is available under the <a href="https://github.com/twbs/bootstrap/blob/master/LICENSE" target="_blank">MIT License</a>.
					</li>
					<li>
						Syntax highlighting is implemented via <a href="https://highlightjs.org" target="_blank">highlight.js</a> licensed under the BSD 3-Clause License and the included github styling made by Vasily Polovnyov.
					</li>
					<li>
						Icons on this site are from <a href="https://fontawesome.com/" target="_blank">Font Awesome</a> which is licensed under the <a href="https://fontawesome.com/license/free" target="_blank">Font Awesome Free License</a>.
					</li></ul>
				<p>Built at 2023-02-10 16:41:13 UTC</p>
			</details>
		</footer>

		
	</body>
</html>