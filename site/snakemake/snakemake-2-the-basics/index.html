<!DOCTYPE html>
<html lang="en">
	<head>
		
		
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<meta name="author" content="Jacques Dainat et al.">
		<link rel="canonical" href="https://Juke34.github.io/workshop-reproducible-research/snakemake/snakemake-2-the-basics/">
		<link rel="shortcut icon" href="../../img/favicon.ico">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<title>The basics - Bioinformatics Workshop on Tools for Reproducible Research</title>
		<link href="../../bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
		<link href="../../css/font-awesome-5.12.2-all.min.css" rel="stylesheet">
		<link href="../../css/base.css" rel="stylesheet">
		<link rel="stylesheet" href="../../css/highlight-github.css">
		<script src="../../bootstrap/dist/js/bootstrap.min.js"></script>
		<script src="../../js/highlight.pack.js"></script>
		
		<script>
			var base_url = '../..';
			var home_url = '../../usage';
			var is_outer_page = false;
			
			var pageToc = [
			];

		</script>
		<script src="../../js/base.js"></script> 
	</head>

	<body class="inner-page">
		

		<div class="container-fluid wm-page-content">
			<a name="_top" aria-hidden="true"></a>
			






<div class="row pt-2 pb-4">
	<div class="col-sm text-center text-sm-left">
		<a href="../snakemake-1-introduction/" class="btn btn-sm btn-outline-dark">
			<i class="fa fa-chevron-left" aria-hidden="true"></i>
			Previous
		</a>
		<a href="../snakemake-1-introduction/" class="btn btn-sm btn-link">
			Introduction
		</a>
	</div>
	

	
	<div class="col-sm text-center text-sm-right">
		<a href="../snakemake-3-visualising-workflows/" class="btn btn-sm btn-link">
			Visualising workflow
		</a>
		<a href="../snakemake-3-visualising-workflows/" class="btn btn-sm btn-outline-dark">
			Next
			<i class="fa fa-chevron-right" aria-hidden="true"></i>
		</a>
	</div>
	
</div>

			

			<p>In this part of the tutorial we will create a very simple workflow from
scratch, in order to show the fundamentals of how Snakemake works. The workflow
will take two files as inputs, <code>a.txt</code> and <code>b.txt</code>, and the purpose is to
convert the text in the files to upper case and then to concatenate them.</p>
<p>Run the following shell commands. The first one will make an empty file named
<code>Snakefile</code>, which will later contain the workflow. The second and third
commands generate two files containing some arbitrary text.</p>
<pre><code class="language-bash">touch Snakefile
echo &quot;This is a.txt&quot; &gt; a.txt
echo &quot;This is b.txt&quot; &gt; b.txt
</code></pre>
<p>Then open <code>Snakefile</code> in your favorite text editor. A Snakemake workflow is based on
rules which take some file(s) as input, performs some type of operation on
them, and generate some file(s) as outputs. Here is a very simple rule that
produces <code>a.upper.txt</code> as an output, using <code>a.txt</code> as input. Copy this rule to 
your <code>Snakefile</code> and save it.</p>
<pre><code class="language-python">rule convert_to_upper_case:
    output:
        &quot;a.upper.txt&quot;
    input:
        &quot;a.txt&quot;
    shell:
        &quot;&quot;&quot;
        tr [a-z] [A-Z] &lt; {input} &gt; {output}
        &quot;&quot;&quot;
</code></pre>
<blockquote>
<p><strong>Attention!</strong> <br>
Indentation is important in Snakefiles, so make sure that you have the
correct number of spaces before <code>input</code>/<code>output</code>/<code>shell</code> and their
respective subsections. The number of spaces per level doesn't matter as
long as you're consistent. Here we use four, but you could just as well use
two for a more compact look. Don't use tabs (unless your editor
automatically converts them to spaces).</p>
</blockquote>
<p>Rules can be given names, here it's <code>convert_to_upper_case</code>. While rule names 
are not strictly necessary we encourage you to use them and to make an effort to 
name your rules in a way that makes it easy to understand the purpose of the rule,
as rule names are one of the main ways to interact with the workflow. The
<code>shell</code> section (or directive) contains the shell commands that will convert the 
text in the input file to upper case and send it to the output file. In the shell 
command string, we can refer to elements of the rule via curly brackets. Here, we 
refer to the output file by specifying <code>{output}</code> and to the input file by 
specifying <code>{input}</code>. If you're not very familiar with Bash, this particular 
command can be read like "send the contents of <code>a.txt</code> to the program <code>tr</code>, which 
will convert all characters in the set <code>[a-z]</code> to the corresponding character in 
the set <code>[A-Z]</code>, and then send the output to <code>a.upper.txt</code>".</p>
<p>Now let's run our first Snakemake workflow. When a workflow is executed
Snakemake tries to generate a set of target files. Target files can be
specified via the command line (or, as you will see later, in several other
ways). Here we ask Snakemake to make the file <code>a.upper.txt</code>. It's good practice
to first run with the flag <code>-n</code> (or <code>--dry-run</code>), which will show what Snakemake
plans to do without actually running anything, and you also need to specify
how many cores to be used for the workflow with <code>--cores</code> or <code>-c</code>. For now, you
only need 1 so set <code>-c 1</code>. You can also use the flag <code>-p</code>, for showing the 
shell commands that it will execute, and the flag <code>-r</code> for showing the reason 
for running a specific rule. <code>snakemake --help</code> will show you all available 
flags.</p>
<pre><code class="language-no-highlight">$ snakemake -n -c 1 -r -p a.upper.txt

Building DAG of jobs...
Job stats:
job                      count    min threads    max threads
---------------------  -------  -------------  -------------
convert_to_upper_case        1              1              1
total                        1              1              1


[Mon Oct 25 16:48:43 2021]
rule convert_to_upper_case:
    input: a.txt
    output: a.upper.txt
    jobid: 0
    reason: Missing output files: a.upper.txt
    resources: tmpdir=/var/folders/p0/6z00kpv16qbf_bt52y4zz2kc0000gp/T


        tr [a-z] [A-Z] &lt; a.txt &gt; a.upper.txt

Job stats:
job                      count    min threads    max threads
---------------------  -------  -------------  -------------
convert_to_upper_case        1              1              1
total                        1              1              1

This was a dry-run (flag -n). The order of jobs does not reflect the order of execution.
</code></pre>
<p>You can see that Snakemake plans to run one job: the rule <code>convert_to_upper_case</code>
with <code>a.txt</code> as input and <code>a.upper.txt</code> as output. The reason for doing this is
that it's missing the file <code>a.upper.txt</code>. Now execute the workflow without the
<code>-n</code> flag and check that the contents of <code>a.upper.txt</code> is as expected. Then try
running the same command again. What do you see? It turns out that Snakemake
only reruns jobs if there have been changes to either <strong>the input files, or the 
workflow itself</strong>. This is how Snakemake ensures that everything in the 
workflow is up to date. We will get back to this shortly.</p>
<p>What if we ask Snakemake to generate the file <code>b.upper.txt</code>?</p>
<pre><code class="language-no-highlight">$ snakemake -n -c 1 -r -p b.upper.txt

Building DAG of jobs...
MissingRuleException:
No rule to produce b.upper.txt (if you use input functions make sure that they don't raise unexpected exceptions).
</code></pre>
<p>That didn't work well. We could copy the rule to make a similar one for
<code>b.txt</code>, but that would be a bit cumbersome. Here is where named wildcards come
in; one of the most powerful features of Snakemake. Simply change the input
from <code>input: "a.txt"</code> to <code>input: "{some_name}.txt"</code> and the output to <code>output:
"{some_name}.upper.txt"</code>. Now try asking for <code>b.upper.txt</code> again.</p>
<p>Tada! What happens here is that Snakemake looks at all the rules it has
available (actually only one in this case) and tries to assign values to all
wildcards so that the targeted files can be generated. In this case it was
quite simple, you can see that it says that <code>wildcards: some_name=b</code>, but for
large workflows and multiple wildcards it can get much more complex. Named
wildcards is what enables a workflow (or single rules) to be efficiently
generalized and reused between projects or shared between people.</p>
<p>It seems we have the first part of our workflow working, now it's time to make
the second rule for concatenating the outputs from <code>convert_to_upper_case</code>. The
rule structure will be similar; the only difference is that here we have two
inputs instead of one. This can be expressed in two ways, either with named
inputs like this:</p>
<pre><code class="language-python">input:
    firstFile=&quot;...&quot;,
    secondFile=&quot;...&quot;
shell:
    &quot;&quot;&quot;
    some_function {input.firstFile} {input.secondFile}
    &quot;&quot;&quot;
</code></pre>
<p>Or with indexes like this:</p>
<pre><code class="language-python">input:
    &quot;...&quot;,
    &quot;...&quot;
shell:
    &quot;&quot;&quot;
    some_function {input[0]} {input[1]}
    &quot;&quot;&quot;
</code></pre>
<blockquote>
<p><strong>Attention!</strong> <br>
If you have multiple inputs or outputs they need to be delimited with
a comma (as seen above). This is a very common mistake when writing
Snakemake workflows. The parser will complain, but sometimes the error
message can be difficult to interpret.</p>
</blockquote>
<p>Now try to construct this rule yourself and name it <code>concatenate_a_and_b</code>. 
The syntax for concatenating two files in Bash is 
<code>cat first_file.txt second_file.txt &gt; output_file.txt</code>. Call the output <code>c.txt</code>.
Run the workflow in Snakemake and validate that the output looks as expected.</p>
<p>Wouldn't it be nice if our workflow could be used for <em>any</em> files, not just
<code>a.txt</code> and <code>b.txt</code>? We can achieve this by using named wildcards (or in other
ways as we will discuss later). As we've mentioned, Snakemake looks at all the
rules it has available and tries to assign values to all wildcards so that the
targeted files can be generated. We therefore have to name the output file in
a way so that it also contains information about which input files it should be
based on. Try to figure out how to do this yourself. If you're stuck you can
look at the spoiler below, but spend some time on it before you look. Also
rename the rule to <code>concatenate_files</code> to reflect its new more general use.</p>
<details>
<summary> Click to show </summary>


<pre><code class="language-python">rule concatenate_files:
    output:
        &quot;{first}_{second}.txt&quot;    
    input:
        &quot;{first}.upper.txt&quot;,
        &quot;{second}.upper.txt&quot;
    shell:
        &quot;&quot;&quot;
        cat {input[0]} {input[1]} &gt; {output}
        &quot;&quot;&quot;
</code></pre>


</details>

<p>We can now control which input files to use by the name of the file we ask
Snakemake to generate. Run the workflow without the flag <code>-n</code> (or <code>--dry-run</code>)
to execute both rules, providing one core with <code>-c 1</code> (or <code>--cores 1</code>):</p>
<pre><code class="language-no-highlight">$ snakemake a_b.txt -c 1

Building DAG of jobs...
Using shell: /bin/bash
Provided cores: 1 (use --cores to define parallelism)
Rules claiming more threads will be scaled down.
Job stats:
job                      count    min threads    max threads
---------------------  -------  -------------  -------------
concatenate_files            1              1              1
convert_to_upper_case        2              1              1
total                        3              1              1

Select jobs to execute...

[Mon Oct 25 16:51:52 2021]
rule convert_to_upper_case:
    input: b.txt
    output: b.upper.txt
    jobid: 2
    wildcards: some_name=b
    resources: tmpdir=/var/folders/p0/6z00kpv16qbf_bt52y4zz2kc0000gp/T

[Mon Oct 25 16:51:53 2021]
Finished job 2.
1 of 3 steps (33%) done
Select jobs to execute...

[Mon Oct 25 16:51:53 2021]
rule convert_to_upper_case:
    input: a.txt
    output: a.upper.txt
    jobid: 1
    wildcards: some_name=a
    resources: tmpdir=/var/folders/p0/6z00kpv16qbf_bt52y4zz2kc0000gp/T

[Mon Oct 25 16:51:53 2021]
Finished job 1.
2 of 3 steps (67%) done
Select jobs to execute...

[Mon Oct 25 16:51:53 2021]
rule concatenate_files:
    input: a.upper.txt, b.upper.txt
    output: a_b.txt
    jobid: 0
    wildcards: first=a, second=b
    resources: tmpdir=/var/folders/p0/6z00kpv16qbf_bt52y4zz2kc0000gp/T

[Mon Oct 25 16:51:53 2021]
Finished job 0.
3 of 3 steps (100%) done
</code></pre>
<p>Neat!</p>
<blockquote>
<p><strong>Tip</strong> <br>
You can name a file whatever you want in a Snakemake workflow, but you will
find that everything falls into place much nicer if the filename reflects
the file's path through the workflow, <em>e.g.</em> <code>sample_a.trimmed.deduplicated.sorted.bam</code>.</p>
<p><strong>Quick recap</strong> <br>
In this section we've learned:</p>
<ul>
<li>How a simple Snakemake rule looks.</li>
<li>How to define target files when executing a workflow.</li>
<li>How to use named wildcards for writing generic and flexible rules.</li>
</ul>
</blockquote>

			<br>
			






<div class="row pt-2 pb-4">
	<div class="col-sm text-center text-sm-left">
		<a href="../snakemake-1-introduction/" class="btn btn-sm btn-outline-dark">
			<i class="fa fa-chevron-left" aria-hidden="true"></i>
			Previous
		</a>
		<a href="../snakemake-1-introduction/" class="btn btn-sm btn-link">
			Introduction
		</a>
	</div>
	

	
	<div class="col-sm text-center text-sm-right">
		<a href="../snakemake-3-visualising-workflows/" class="btn btn-sm btn-link">
			Visualising workflow
		</a>
		<a href="../snakemake-3-visualising-workflows/" class="btn btn-sm btn-outline-dark">
			Next
			<i class="fa fa-chevron-right" aria-hidden="true"></i>
		</a>
	</div>
	
</div>

			<br>
		</div>

		<footer class="container-fluid wm-page-content text-center small">
			<p>
			<a href="https://github.com/Juke34/workshop-reproducible-research/edit/master/docs/snakemake/snakemake-2-the-basics.md" target="_blank">Edit on workshop-reproducible-research</a>
			</p>
			<details>
				<summary>
					Documentation built with <a href="http://www.mkdocs.org/" target="_blank">MkDocs</a> using  <a href="https://github.com/Siphalor/mkdocs-custommill" target="_blank">CustomMill</a>.
				</summary>
				<h6 class="mt-2">Additional Licenses</h6>
				<ul><li>
						CustomMill is based on the <a href="https://github.com/gristlabs/mkdocs-windmill" target="_blank">Windmill</a> theme by Grist Labs, licensed under the <a href="https://github.com/gristlabs/mkdocs-windmill/blob/master/LICENSE" target="_blank">MIT License</a>
					</li>
					<li>
						CustomMill includes <a href="https://getbootstrap.com" target="_blank">Bootstrap</a> version 5.1.3. This is available under the <a href="https://github.com/twbs/bootstrap/blob/master/LICENSE" target="_blank">MIT License</a>.
					</li>
					<li>
						Syntax highlighting is implemented via <a href="https://highlightjs.org" target="_blank">highlight.js</a> licensed under the BSD 3-Clause License and the included github styling made by Vasily Polovnyov.
					</li>
					<li>
						Icons on this site are from <a href="https://fontawesome.com/" target="_blank">Font Awesome</a> which is licensed under the <a href="https://fontawesome.com/license/free" target="_blank">Font Awesome Free License</a>.
					</li></ul>
				<p>Built at 2023-02-10 16:41:13 UTC</p>
			</details>
		</footer>

		
	</body>
</html>